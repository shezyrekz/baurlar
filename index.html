<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Шежіре</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #f6f1d1;
  }
  header {
    background: #26a69a;
    color: white;
    height: 55px;
    display: flex;
    align-items: center;
    padding: 0 18px;
    gap: 22px;
  }
  header .icon {
    cursor: pointer;
    font-size: 26px;
    user-select: none;
    transition: transform 0.2s, opacity 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 5px;
    border-radius: 5px;
  }
  header .icon:hover {
    transform: scale(1.1);
    background: rgba(255, 255, 255, 0.1);
  }
  header .icon.active {
    background: rgba(255, 255, 255, 0.2);
    transform: scale(1.05);
  }
  
  /* КОНТЕЙНЕРЫ ДЛЯ РАЗНЫХ СЕКЦИЙ */
  .section {
    display: none;
    width: 100%;
    height: calc(100vh - 55px);
    padding: 20px;
    box-sizing: border-box;
    overflow: auto;
  }
  
  .section.active {
    display: block;
  }
  
  /* СЕКЦИЯ ЛЮДИ (ДЕРЕВО) */
  #people-section {
    background: #f6f1d1;
  }
  
  /* СЕКЦИЯ ПОИСК */
  #search-section {
    background: #f6f1d1;
  }
  
  .search-container {
    max-width: 600px;
    margin: 0 auto;
    padding: 20px;
  }
  
  .search-box {
    width: 100%;
    padding: 15px;
    font-size: 16px;
    border: 2px solid #26a69a;
    border-radius: 25px;
    margin-bottom: 20px;
    box-sizing: border-box;
  }
  
  .search-results {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }
  
  .result-item {
    padding: 10px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
  }
  
  .result-item:hover {
    background: #f0f9f7;
  }
  
  /* СЕКЦИЯ ДОБАВИТЬ */
  #add-section {
    background: #f6f1d1;
  }
  
  .add-form {
    max-width: 500px;
    margin: 0 auto;
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }
  
  .form-group {
    margin-bottom: 20px;
  }
  
  .form-group label {
    display: block;
    margin-bottom: 5px;
    color: #333;
    font-weight: bold;
  }
  
  .form-group input,
  .form-group select {
    width: 100%;
    padding: 10px;
    border: 2px solid #ddd;
    border-radius: 5px;
    font-size: 16px;
    box-sizing: border-box;
  }
  
  .form-group input:focus,
  .form-group select:focus {
    border-color: #26a69a;
    outline: none;
  }
  
  .submit-btn {
    background: #26a69a;
    color: white;
    border: none;
    padding: 12px 30px;
    font-size: 16px;
    border-radius: 5px;
    cursor: pointer;
    width: 100%;
  }
  
  .submit-btn:hover {
    background: #1e887c;
  }
  
  /* СЕКЦИЯ ПОМОЩЬ */
  #help-section {
    background: #f6f1d1;
  }
  
  .help-content {
    max-width: 800px;
    margin: 0 auto;
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }
  
  .help-item {
    margin-bottom: 25px;
  }
  
  .help-item h3 {
    color: #26a69a;
    margin-bottom: 10px;
  }
  
  /* СЕКЦИЯ СТАТИСТИКА */
  #stats-section {
    background: #f6f1d1;
  }
  
  .stats-container {
    max-width: 800px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
  }
  
  .stat-card {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    text-align: center;
  }
  
  .stat-number {
    font-size: 36px;
    font-weight: bold;
    color: #26a69a;
    margin: 10px 0;
  }
  
  .stat-label {
    color: #666;
    font-size: 14px;
  }
  
  /* СТИЛИ ДЛЯ ДЕРЕВА */
  #tree-container {
    width: 100%;
    height: 100%;
    cursor: move;
  }
  
  .node-group {
    cursor: pointer;
  }
  
  .node-card {
    fill: #26a69a; /* ЗЕЛЕНЫЙ ЦВЕТ КАК ВЕРХНЯЯ ПАНЕЛЬ */
    stroke: #1e887c;
    stroke-width: 2px;
    rx: 12px;
    ry: 12px;
    filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.2));
    transition: all 0.3s ease;
  }
  
  .node-card:hover {
    filter: drop-shadow(3px 3px 6px rgba(0,0,0,0.3));
    fill: #2bbbad; /* Светлее при наведении */
  }
  
  .node-card.selected {
    fill: #1e887c; /* Темнее при выборе */
    stroke: #15776b;
    stroke-width: 3px;
    filter: drop-shadow(4px 4px 8px rgba(0,0,0,0.4));
  }
  
  .node-card.collapsed {
    fill: #4CAF50; /* Другой оттенок зеленого для свернутых */
    stroke: #388E3C;
  }
  
  .node-card.expanded {
    fill: #26a69a; /* Основной зеленый для развернутых */
    stroke: #1e887c;
  }
  
  .node-image-container {
    clip-path: circle(50% at 50% 50%);
  }
  
  .node-image {
    pointer-events: none;
    user-select: none;
  }
  
  .node-text {
    font-size: 13px;
    pointer-events: none;
    user-select: none;
    fill: white;
    font-weight: 600;
    text-anchor: start;
    dominant-baseline: central;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
  }
  
  .link {
    fill: none;
    stroke: #789d92;
    stroke-width: 2px;
    opacity: 0.7;
    transition: opacity 0.3s;
  }
  
  .link:hover {
    opacity: 1;
    stroke-width: 3px;
  }
  
  .floating-btn {
    position: fixed;
    bottom: 30px;
    right: 30px;
    background: #ff9800;
    color: white;
    border-radius: 50%;
    width: 56px;
    height: 56px;
    font-size: 36px;
    line-height: 56px;
    text-align: center;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    user-select: none;
    z-index: 100;
  }
</style>
</head>
<body>

<header>
  <div class="icon active" title="Люди" data-section="people"><i class="fas fa-users"></i></div>
  <div class="icon" title="Поиск" data-section="search"><i class="fas fa-search"></i></div>
  <div class="icon" title="Добавить" data-section="add"><i class="fas fa-user-plus"></i></div>
  <div class="icon" title="Помощь" data-section="help"><i class="fas fa-question-circle"></i></div>
  <div class="icon" title="Статистика" data-section="stats"><i class="fas fa-chart-bar"></i></div>
</header>

<!-- СЕКЦИЯ ЛЮДИ (ДЕРЕВО) -->
<div id="people-section" class="section active">
  <div id="tree-container"></div>
  <div class="floating-btn" title="Добавить узел">+</div>
</div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
  // ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ
  let i = 0;
  let selectedNode = null;
  let currentTreeData = {
    name: "Алаш",
    children: [
      { 
        name: "Ұлы жүз",
        children: [
          { name: "Қанлы" },
          { name: "Шанышқылы" },
          { name: "Сіргелі" },
          { name: "Шақшам" },
          { name: "Сарыүйсін" },
          { name: "Шапырашты" },
          { name: "Жалайыр" },
          { name: "Ысты" },
          { name: "Ошақты" },
          { name: "Албан" },
          { name: "Суан" },
          { name: "Дулат" }
        ]
      },
      { 
        name: "Орта жүз",
        children: [
          { name: "Арғын" },
          { name: "Найман" },
          { name: "Қонырат" },
          { name: "Қыпшақ" },
          { name: "Керей" },
          { name: "Уақ" }
        ]
      },
      { 
        name: "Кіші жүз",
        children: [
          { name: "Қайырбай-Қаракесек" },
          { name: "Байұлы" },
          { name: "Жетіру" }
        ]
      },
      { 
        name: "Жүзден тыс",
        children: [
          { name: "Төре" },
          { name: "Төлеңгіт" },
          { name: "Қожа" },
          { name: "Сұнақ" },
          { name: "Қырғыз" },
          { name: "Ноғай-Қазақ" },
          { name: "Маңғыт" },
          { name: "Көлеген" },
          { name: "Кенегес" },
          { name: "Қият" }
        ]
      }
    ]
  };

  // ========== ИНИЦИАЛИЗАЦИЯ ДЕРЕВА ==========
function initTree() {
  const width = window.innerWidth;
  const height = window.innerHeight - 55;

  d3.select("#tree-container").html("");

  const svg = d3.select("#tree-container")
    .append("svg")
    .attr("width", width)
    .attr("height", height);

  const g = svg.append("g")
    .attr("transform", `translate(${width / 2 - 80}, ${height / 2})`);

  // ZOOM функция
  const zoom = d3.zoom()
    .scaleExtent([0.1, 3])
    .on("zoom", (event) => {
      g.attr("transform", event.transform);
    });
  
  svg.call(zoom)
    .on("dblclick.zoom", null);

  const treeLayout = d3.tree()
    .nodeSize([100, 250]);

  let root = d3.hierarchy(currentTreeData);

  // СВОРАЧИВАЕМ ВСЕ УЗЛЫ КРОМЕ АЛАШ
  function collapseAllExceptRoot(d) {
    if (d.depth > 0 && d.children) {
      d._children = d.children;
      d._children.forEach(collapseAllExceptRoot);
      d.children = null;
    }
  }
  
  if (root.children) {
    root.children.forEach(collapseAllExceptRoot);
  }

  root.x0 = 0;
  root.y0 = 0;

  updateTree(root);

  function updateTree(source) {
    const duration = 400;
    treeLayout(root);

    const nodes = root.descendants();
    const links = root.links();

    const node = g.selectAll("g.node-group")
      .data(nodes, d => d.id || (d.id = ++i));

    /* ===== EXIT ===== */
    node.exit()
      .transition().duration(duration)
      .attr("transform", d => `translate(${source.y},${source.x})`)
      .style("opacity", 0)
      .remove();

    /* ===== ENTER ===== */
    const nodeEnter = node.enter()
      .append("g")
      .attr("class", "node-group")
      .attr("transform", `translate(${source.y0},${source.x0})`)
      .style("opacity", 0)
      .on("click", (e, d) => {
        e.stopPropagation();
        
        // Снимаем выделение с предыдущего узла
        if (selectedNode) {
          d3.select(selectedNode).select(".node-card").classed("selected", false);
        }
        
        // Выделяем текущий узел
        const currentNode = d3.select(e.currentTarget);
        currentNode.select(".node-card").classed("selected", true);
        selectedNode = e.currentTarget;
        
        // Показываем информацию о выбранном узле
        showNodeInfo(d);
        
        // Раскрываем/сворачиваем
        if (d.children) {
          d._children = d.children;
          d.children = null;
        } else {
          d.children = d._children;
          d._children = null;
        }
        updateTree(d);
      });

    // КАРТОЧКА УЗЛА - ВСЕ ЗЕЛЕНЫЕ
    nodeEnter.append("rect")
      .attr("class", d => {
        let cardClass = "node-card";
        if (d._children) cardClass += " collapsed";
        if (d.children) cardClass += " expanded";
        return cardClass;
      })
      .attr("x", 0)
      .attr("y", -25)
      .attr("width", 160)
      .attr("height", 50)
      .attr("rx", 12)
      .attr("ry", 12);

    // КРУГЛАЯ МАСКА ДЛЯ ФОТО
    nodeEnter.append("clipPath")
      .attr("id", d => `clip-${d.id}`)
      .append("circle")
      .attr("cx", 30)
      .attr("cy", 0)
      .attr("r", 20);

    // ФОТО
    nodeEnter.append("image")
      .attr("x", 10)
      .attr("y", -20)
      .attr("width", 40)
      .attr("height", 40)
      .attr("href", "images/yurt.png")
      .attr("clip-path", d => `url(#clip-${d.id})`)
      .attr("preserveAspectRatio", "xMidYMid slice");

    // ТЕКСТ
    nodeEnter.append("text")
      .attr("class", "node-text")
      .attr("x", 60)
      .attr("y", 0)
      .attr("dy", "0.35em")
      .text(d => d.data.name);

    /* ===== UPDATE ===== */
    const nodeUpdate = nodeEnter.merge(node);

    nodeUpdate.transition()
      .duration(duration)
      .attr("transform", d => `translate(${d.y},${d.x})`)
      .style("opacity", 1);

    // Обновляем класс карточки
    nodeUpdate.select("rect")
      .attr("class", d => {
        let cardClass = "node-card";
        if (d._children) cardClass += " collapsed";
        if (d.children) cardClass += " expanded";
        return cardClass;
      });

    // Подгоняем ширину карточки под текст
    nodeUpdate.select("rect")
      .transition()
      .duration(duration)
      .attr("width", function() {
        const text = this.parentNode.querySelector("text");
        const textWidth = text ? text.getBBox().width : 0;
        return Math.max(160, textWidth + 70);
      });

    /* ===== LINKS ===== */
    const link = g.selectAll("path.link")
      .data(links, d => d.target.id);

    link.exit()
      .transition().duration(duration)
      .style("opacity", 0)
      .remove();

    link.enter()
      .append("path")
      .attr("class", "link")
      .merge(link)
      .transition()
      .duration(duration)
      .attr("d", d => {
        const sourceNode = d.source;
        const targetNode = d.target;
        const sourceRect = sourceNode.nodeRectWidth || 160;
        const targetRect = targetNode.nodeRectWidth || 160;
        
        const startX = sourceNode.y + sourceRect;
        const endX = targetNode.y;
        const startY = sourceNode.x;
        const endY = targetNode.x;
        
        const controlX1 = startX + (endX - startX) * 0.5;
        const controlX2 = startX + (endX - startX) * 0.5;
        
        return `
          M ${startX} ${startY}
          C ${controlX1} ${startY},
            ${controlX2} ${endY},
            ${endX} ${endY}
        `;
      })
      .style("opacity", 0.7);

    // Сохраняем ширину карточки для узла
    nodes.forEach(d => {
      d.x0 = d.x;
      d.y0 = d.y;
      const nodeElement = d3.select(d3.selectAll(".node-group").nodes()[nodes.indexOf(d)]);
      if (nodeElement.size() > 0) {
        const rect = nodeElement.select("rect").node();
        if (rect) {
          d.nodeRectWidth = rect.getBBox().width;
        }
      }
    });
  }

  // Функция показа информации о выбранном узле
  function showNodeInfo(node) {
    const depthNames = ["Ата", "Жуз", "Ру", "Тайпа", "Ру", "Ата", "Бала"];
    const depthName = depthNames[Math.min(node.depth, depthNames.length - 1)];
    
    const info = `
      Выбрано: <strong>${node.data.name}</strong>
      Уровень: ${depthName} (${node.depth})
      ${node.children || node._children ? `Детей: ${(node.children || node._children).length}` : 'Конечный узел'}
    `;
    
    // Можно заменить на более красивый попап
    console.log(info);
  }

  // Центрируем дерево после загрузки
  setTimeout(() => {
    const initialTransform = d3.zoomIdentity
      .translate(width / 2 - 80, height / 2 - 100)
      .scale(1);
    svg.call(zoom.transform, initialTransform);
  }, 100);
}

  // ========== ИНИЦИАЛИЗАЦИЯ ПРИ ЗАГРУЗКЕ ==========
  document.addEventListener('DOMContentLoaded', function() {
    initTree();
    
    window.addEventListener('resize', function() {
      if (document.getElementById('people-section').classList.contains('active')) {
        setTimeout(initTree, 100);
      }
    });
  });
</script>
</body>
</html>
