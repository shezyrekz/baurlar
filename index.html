<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Шежіре</title>
<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #f6f1d1;
  }
  /* УВЕЛИЧИЛ ВЕРХНЮЮ ПАНЕЛЬ */
  header {
    background: #009688;
    color: white;
    height: 70px; /* Увеличено с 50px до 70px */
    display: flex;
    align-items: center;
    padding: 0 25px; /* Увеличено с 15px до 25px */
    gap: 30px; /* Увеличено с 20px до 30px */
  }
  header .icon {
    cursor: pointer;
    font-size: 32px; /* Увеличено с 24px до 32px */
    user-select: none;
    transition: transform 0.2s; /* Добавил плавный эффект */
  }
  header .icon:hover {
    transform: scale(1.1); /* Легкое увеличение при наведении */
  }
  #tree {
    padding: 20px;
    overflow: auto;
    height: calc(100vh - 70px); /* Учтено увеличение высоты header */
  }
  .node circle {
    cursor: pointer;
    fill: #a1c2bb;
    stroke: #456d61;
    stroke-width: 1.5px;
  }
  .node text {
    font-size: 14px;
    pointer-events: none;
    user-select: none;
  }
  .link {
    fill: none;
    stroke: #456d61;
    stroke-width: 2px;
  }
  .floating-btn {
    position: fixed;
    bottom: 30px;
    right: 30px;
    background: #ff9800;
    color: white;
    border-radius: 50%;
    width: 56px;
    height: 56px;
    font-size: 36px;
    line-height: 56px;
    text-align: center;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    user-select: none;
  }
</style>
</head>
<body>

<header>
  <div class="icon" title="Люди">&#128101;</div>
  <div class="icon" title="Поиск">&#128269;</div>
  <div class="icon" title="Добавить">&#128100;</div>
  <div class="icon" title="Помощь">?</div>
  <div class="icon" title="Статистика">&#128202;</div>
</header>

<div id="tree"></div>

<div class="floating-btn" title="Добавить узел">+</div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
  const treeData = {
    name: "Алаш",
    children: [
      { name: "Ұлы жүз",
        children: [
          { name: "Қаны" },
          { name: "Шанышқылы" },
          { name: "Сіргелі" },
          { name: "Шақшам" },
          { name: "Сарүйсін", children: [
            { name: "Қалша" },
            { name: "Жақып" }
          ] },
          { name: "Шапырашты" },
          { name: "Жалайыр (600-700)" },
          { name: "Ысты" },
          { name: "Ошақты" },
          { name: "Албан" },
          { name: "Суан" },
          { name: "Дулат" }
        ]
      },
      { name: "Орта жүз" },
      { name: "Кіші жүз" },
      { name: "Жүзден тыс" }
    ]
  };

  const width = window.innerWidth;
  const height = window.innerHeight - 70; /* Учтено увеличение высоты header */

  const svg = d3.select("#tree").append("svg")
    .attr("width", width)
    .attr("height", height);

  const g = svg.append("g").attr("transform", "translate(40,40)");

  const treeLayout = d3.tree().size([height - 80, width - 160]);

  let root = d3.hierarchy(treeData);

  // Функция для сворачивания всех детей узла
  function collapse(d) {
    if(d.children) {
      d._children = d.children;
      d._children.forEach(collapse);
      d.children = null;
    }
  }

  root.x0 = height / 2;
  root.y0 = 0;

  // УБРАЛ СВОРАЧИВАНИЕ ПРИ ЗАГРУЗКЕ - теперь все узлы видны сразу
  // root.children.forEach(collapse); // ЗАКОММЕНТИРОВАНО

  update(root);

  function update(source) {
    const treeData = treeLayout(root);

    const nodes = treeData.descendants();
    const links = treeData.links();

    // Нормализуем позиции по Y
    nodes.forEach(d => d.y = d.depth * 180);

    // **************** Nodes section ***************************

    // Обновление узлов
    const node = g.selectAll('g.node')
      .data(nodes, d => d.id || (d.id = ++i));

    // Удаление ушедших
    const nodeExit = node.exit()
      .transition()
      .duration(200)
      .attr("transform", d => `translate(${source.y},${source.x})`)
      .remove();

    // Вход новых узлов
    const nodeEnter = node.enter()
      .append('g')
      .attr('class', 'node')
      .attr("transform", d => `translate(${source.y0},${source.x0})`)
      .on('click', (event, d) => {
        if(d.children) {
          d._children = d.children;
          d.children = null;
        } else {
          d.children = d._children;
          d._children = null;
        }
        update(d);
      });

    nodeEnter.append('circle')
      .attr('r', 1e-6)
      .attr('fill', d => d._children ? "#a1c2bb" : "#69b3a2")
      .attr('stroke', '#456d61')
      .attr('stroke-width', 2);

    nodeEnter.append('text')
      .attr("dy", 5)
      .attr("x", d => d.children || d._children ? -25 : 25)
      .style("text-anchor", d => d.children || d._children ? "end" : "start")
      .text(d => d.data.name);

    // Обновляем позиции существующих узлов
    const nodeUpdate = nodeEnter.merge(node);

    nodeUpdate.transition()
      .duration(200)
      .attr("transform", d => `translate(${d.y},${d.x})`);

    nodeUpdate.select('circle')
      .attr('r', 20)
      .attr('fill', d => d._children ? "#a1c2bb" : "#69b3a2");

    // **************** Links section ***************************

    // Обновляем связи
    const link = g.selectAll('path.link')
      .data(links, d => d.target.id);

    // Удаляем старые ссылки
    link.exit()
      .transition()
      .duration(200)
      .attr('d', d => {
        const o = {x: source.x, y: source.y};
        return diagonal(o, o);
      })
      .remove();

    // Добавляем новые ссылки
    const linkEnter = link.enter()
      .insert('path', "g")
      .attr("class", "link")
      .attr('d', d => {
        const o = {x: source.x0, y: source.y0};
        return diagonal(o, o);
      });

    // Обновляем позиции ссылок
    const linkUpdate = linkEnter.merge(link);

    linkUpdate.transition()
      .duration(200)
      .attr('d', d => diagonal(d.source, d.target));

    // Сохраняем текущие позиции для анимации
    nodes.forEach(d => {
      d.x0 = d.x;
      d.y0 = d.y;
    });
  }

  // Функция для рисования линий между узлами (диагональная кривая)
  function diagonal(s, d) {
    return `M ${s.y} ${s.x}
            C ${(s.y + d.y) / 2} ${s.x},
              ${(s.y + d.y) / 2} ${d.x},
              ${d.y} ${d.x}`;
  }

  let i = 0;
</script>

</body>
</html>
