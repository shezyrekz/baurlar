<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–®–µ–∂—ñ—Ä–µ</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #f6f1d1;
  }
  header {
    background: #26a69a;
    color: white;
    height: 55px;
    display: flex;
    align-items: center;
    padding: 0 18px;
    gap: 22px;
  }
  header .icon {
    cursor: pointer;
    font-size: 26px;
    user-select: none;
    transition: transform 0.2s, opacity 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 5px;
    border-radius: 5px;
  }
  header .icon:hover {
    transform: scale(1.1);
    background: rgba(255, 255, 255, 0.1);
  }
  header .icon.active {
    background: rgba(255, 255, 255, 0.2);
    transform: scale(1.05);
  }
  
  /* –ö–û–ù–¢–ï–ô–ù–ï–†–´ –î–õ–Ø –†–ê–ó–ù–´–• –°–ï–ö–¶–ò–ô */
  .section {
    display: none;
    width: 100%;
    height: calc(100vh - 55px);
    padding: 20px;
    box-sizing: border-box;
    overflow: auto;
  }
  
  .section.active {
    display: block;
  }
  
  /* –°–ï–ö–¶–ò–Ø –õ–Æ–î–ò (–î–ï–†–ï–í–û) */
  #people-section {
    background: #f6f1d1;
  }
  
  /* –°–ï–ö–¶–ò–Ø –ü–û–ò–°–ö */
  #search-section {
    background: #f6f1d1;
  }
  
  .search-container {
    max-width: 600px;
    margin: 0 auto;
    padding: 20px;
  }
  
  .search-box {
    width: 100%;
    padding: 15px;
    font-size: 16px;
    border: 2px solid #26a69a;
    border-radius: 25px;
    margin-bottom: 20px;
    box-sizing: border-box;
  }
  
  .search-results {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }
  
  .result-item {
    padding: 10px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
  }
  
  .result-item:hover {
    background: #f0f9f7;
  }
  
  /* –°–ï–ö–¶–ò–Ø –î–û–ë–ê–í–ò–¢–¨ */
  #add-section {
    background: #f6f1d1;
  }
  
  .add-form {
    max-width: 500px;
    margin: 0 auto;
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }
  
  .form-group {
    margin-bottom: 20px;
  }
  
  .form-group label {
    display: block;
    margin-bottom: 5px;
    color: #333;
    font-weight: bold;
  }
  
  .form-group input,
  .form-group select {
    width: 100%;
    padding: 10px;
    border: 2px solid #ddd;
    border-radius: 5px;
    font-size: 16px;
    box-sizing: border-box;
  }
  
  .form-group input:focus,
  .form-group select:focus {
    border-color: #26a69a;
    outline: none;
  }
  
  .submit-btn {
    background: #26a69a;
    color: white;
    border: none;
    padding: 12px 30px;
    font-size: 16px;
    border-radius: 5px;
    cursor: pointer;
    width: 100%;
  }
  
  .submit-btn:hover {
    background: #1e887c;
  }
  
  /* –°–ï–ö–¶–ò–Ø –ü–û–ú–û–©–¨ */
  #help-section {
    background: #f6f1d1;
  }
  
  .help-content {
    max-width: 800px;
    margin: 0 auto;
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }
  
  .help-item {
    margin-bottom: 25px;
  }
  
  .help-item h3 {
    color: #26a69a;
    margin-bottom: 10px;
  }
  
  /* –°–ï–ö–¶–ò–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê */
  #stats-section {
    background: #f6f1d1;
  }
  
  .stats-container {
    max-width: 800px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
  }
  
  .stat-card {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    text-align: center;
  }
  
  .stat-number {
    font-size: 36px;
    font-weight: bold;
    color: #26a69a;
    margin: 10px 0;
  }
  
  .stat-label {
    color: #666;
    font-size: 14px;
  }
  
  /* –°–¢–ò–õ–ò –î–õ–Ø –î–ï–†–ï–í–ê */
  #tree-container {
    width: 100%;
    height: 100%;
    cursor: move;
  }
  
  .node-group {
    cursor: pointer;
  }
  
  .node-card {
    fill: white;
    stroke: #456d61;
    stroke-width: 2px;
    rx: 15px;
    ry: 15px;
    filter: drop-shadow(2px 2px 6px rgba(0,0,0,0.15));
    transition: all 0.3s ease;
  }
  
  .node-card:hover {
    filter: drop-shadow(3px 3px 8px rgba(0,0,0,0.2));
    stroke-width: 3px;
  }
  
  .node-card.collapsed {
    stroke: #4CAF50;
    fill: #f8fff8;
  }
  
  .node-card.expanded {
    stroke: #26a69a;
    fill: #f8fdff;
  }
  
  .node-text {
    font-size: 13px;
    pointer-events: none;
    user-select: none;
    fill: #333;
    font-weight: 600;
    text-anchor: start;
    dominant-baseline: central;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  }
  
  .link {
    fill: none;
    stroke: #789d92;
    stroke-width: 2px;
    opacity: 0.7;
    transition: opacity 0.3s;
  }
  
  .link:hover {
    opacity: 1;
    stroke-width: 3px;
  }
  
  .floating-btn {
    position: fixed;
    bottom: 30px;
    right: 30px;
    background: #ff9800;
    color: white;
    border-radius: 50%;
    width: 56px;
    height: 56px;
    font-size: 36px;
    line-height: 56px;
    text-align: center;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    user-select: none;
    z-index: 100;
  }
</style>
</head>
<body>

<header>
  <div class="icon active" title="–õ—é–¥–∏" data-section="people"><i class="fas fa-users"></i></div>
  <div class="icon" title="–ü–æ–∏—Å–∫" data-section="search"><i class="fas fa-search"></i></div>
  <div class="icon" title="–î–æ–±–∞–≤–∏—Ç—å" data-section="add"><i class="fas fa-user-plus"></i></div>
  <div class="icon" title="–ü–æ–º–æ—â—å" data-section="help"><i class="fas fa-question-circle"></i></div>
  <div class="icon" title="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞" data-section="stats"><i class="fas fa-chart-bar"></i></div>
</header>

<!-- –°–ï–ö–¶–ò–Ø –õ–Æ–î–ò (–î–ï–†–ï–í–û) -->
<div id="people-section" class="section active">
  <div id="tree-container"></div>
  <div class="floating-btn" title="–î–æ–±–∞–≤–∏—Ç—å —É–∑–µ–ª">+</div>
</div>

<!-- –°–ï–ö–¶–ò–Ø –ü–û–ò–°–ö -->
<div id="search-section" class="section">
  <div class="search-container">
    <input type="text" class="search-box" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∞–º...">
    <div class="search-results">
      <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞:</h3>
      <div id="search-results-list"></div>
    </div>
  </div>
</div>

<!-- –°–ï–ö–¶–ò–Ø –î–û–ë–ê–í–ò–¢–¨ -->
<div id="add-section" class="section">
  <div class="add-form">
    <h2>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞</h2>
    <div class="form-group">
      <label for="person-name">–ò–º—è:</label>
      <input type="text" id="person-name" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è">
    </div>
    <div class="form-group">
      <label for="parent-select">–†–æ–¥–∏—Ç–µ–ª—å:</label>
      <select id="parent-select">
        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–¥–∏—Ç–µ–ª—è</option>
      </select>
    </div>
    <div class="form-group">
      <label for="person-info">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</label>
      <input type="text" id="person-info" placeholder="–ì–æ–¥—ã –∂–∏–∑–Ω–∏, –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è...">
    </div>
    <button class="submit-btn">–î–æ–±–∞–≤–∏—Ç—å –≤ –¥–µ—Ä–µ–≤–æ</button>
  </div>
</div>

<!-- –°–ï–ö–¶–ò–Ø –ü–û–ú–û–©–¨ -->
<div id="help-section" class="section">
  <div class="help-content">
    <h2>–ü–æ–º–æ—â—å –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –®–µ–∂—ñ—Ä–µ</h2>
    
    <div class="help-item">
      <h3>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–µ—Ä–µ–≤–æ–º</h3>
      <p>‚Ä¢ –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫—Ä—É–∂–æ–∫, —á—Ç–æ–±—ã —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å/—Å–≤–µ—Ä–Ω—É—Ç—å –≤–µ—Ç–∫—É</p>
      <p>‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "+" –≤ –ø—Ä–∞–≤–æ–º –Ω–∏–∂–Ω–µ–º —É–≥–ª—É –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è</p>
      <p>‚Ä¢ –í—Å–µ —É–∑–ª—ã –º–æ–∂–Ω–æ —Ä–∞—Å–∫—Ä—ã–≤–∞—Ç—å/—Å–∫—Ä—ã–≤–∞—Ç—å –ø–æ –∫–ª–∏–∫—É</p>
      <p>‚Ä¢ <strong>–ó–∞–∂–º–∏—Ç–µ –ª–µ–≤—É—é –∫–Ω–æ–ø–∫—É –º—ã—à–∏ –∏ –¥–≤–∏–≥–∞–π—Ç–µ –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –¥–µ—Ä–µ–≤–∞</strong></p>
      <p>‚Ä¢ <strong>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–ª–µ—Å–∏–∫–æ –º—ã—à–∏ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è/—É–º–µ–Ω—å—à–µ–Ω–∏—è</strong></p>
    </div>
    
    <div class="help-item">
      <h3>üîç –ü–æ–∏—Å–∫</h3>
      <p>‚Ä¢ –í–≤–µ–¥–∏—Ç–µ –∏–º—è –≤ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞</p>
      <p>‚Ä¢ –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ —ç—Ç–æ–º—É —á–µ–ª–æ–≤–µ–∫—É –≤ –¥–µ—Ä–µ–≤–µ</p>
    </div>
    
    <div class="help-item">
      <h3>üë§ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª—é–¥–µ–π</h3>
      <p>‚Ä¢ –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –≤ —Ä–∞–∑–¥–µ–ª–µ "–î–æ–±–∞–≤–∏—Ç—å"</p>
      <p>‚Ä¢ –í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–¥–∏—Ç–µ–ª—è –∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –≤ –¥–µ—Ä–µ–≤–µ</p>
      <p>‚Ä¢ –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥–æ–±–∞–≤—å—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é</p>
    </div>
    
    <div class="help-item">
      <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
      <p>‚Ä¢ –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–π—Ç–µ –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤–∞—à–µ–≥–æ –¥–µ—Ä–µ–≤–∞</p>
      <p>‚Ä¢ –£–∑–Ω–∞–π—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª—é–¥–µ–π –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —É—Ä–æ–≤–Ω—è—Ö</p>
    </div>
  </div>
</div>

<!-- –°–ï–ö–¶–ò–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê -->
<div id="stats-section" class="section">
  <div class="stats-container">
    <div class="stat-card">
      <h3>–í—Å–µ–≥–æ –ª—é–¥–µ–π</h3>
      <div class="stat-number" id="total-people">0</div>
      <div class="stat-label">–≤ –¥–µ—Ä–µ–≤–µ</div>
    </div>
    
    <div class="stat-card">
      <h3>–£—Ä–æ–≤–Ω–µ–π</h3>
      <div class="stat-number" id="total-levels">0</div>
      <div class="stat-label">–≥–ª—É–±–∏–Ω–∞ –¥–µ—Ä–µ–≤–∞</div>
    </div>
    
    <div class="stat-card">
      <h3>–í–µ—Ç–æ–∫</h3>
      <div class="stat-number" id="total-branches">0</div>
      <div class="stat-label">–æ—Å–Ω–æ–≤–Ω—ã–µ –≤–µ—Ç–≤–∏</div>
    </div>
    
    <div class="stat-card">
      <h3>–õ–∏—Å—Ç—å–µ–≤</h3>
      <div class="stat-number" id="total-leaves">0</div>
      <div class="stat-label">–∫–æ–Ω–µ—á–Ω—ã–µ —É–∑–ª—ã</div>
    </div>
  </div>
</div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
  // –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
  let i = 0;
  let currentTreeData = {
    name: "–ê–ª–∞—à",
    children: [
      { 
        name: "“∞–ª—ã –∂“Ø–∑",
        children: [
          { name: "“ö–∞–Ω–ª—ã" },
          { name: "–®–∞–Ω—ã—à“õ—ã–ª—ã" },
          { name: "–°—ñ—Ä–≥–µ–ª—ñ" },
          { name: "–®–∞“õ—à–∞–º" },
          { name: "–°–∞—Ä—ã“Ø–π—Å—ñ–Ω" },
          { name: "–®–∞–ø—ã—Ä–∞—à—Ç—ã" },
          { name: "–ñ–∞–ª–∞–π—ã—Ä" },
          { name: "–´—Å—Ç—ã" },
          { name: "–û—à–∞“õ—Ç—ã" },
          { name: "–ê–ª–±–∞–Ω" },
          { name: "–°—É–∞–Ω" },
          { name: "–î—É–ª–∞—Ç" }
        ]
      },
      { 
        name: "–û—Ä—Ç–∞ –∂“Ø–∑",
        children: [
          { name: "–ê—Ä“ì—ã–Ω" },
          { name: "–ù–∞–π–º–∞–Ω" },
          { name: "“ö–æ–Ω—ã—Ä–∞—Ç" },
          { name: "“ö—ã–ø—à–∞“õ" },
          { name: "–ö–µ—Ä–µ–π" },
          { name: "–£–∞“õ" }
        ]
      },
      { 
        name: "–ö—ñ—à—ñ –∂“Ø–∑",
        children: [
          { name: "“ö–∞–π—ã—Ä–±–∞–π-“ö–∞—Ä–∞–∫–µ—Å–µ–∫" },
          { name: "–ë–∞–π“±–ª—ã" },
          { name: "–ñ–µ—Ç—ñ—Ä—É" }
        ]
      },
      { 
        name: "–ñ“Ø–∑–¥–µ–Ω —Ç—ã—Å",
        children: [
          { name: "–¢”©—Ä–µ" },
          { name: "–¢”©–ª–µ“£–≥—ñ—Ç" },
          { name: "“ö–æ–∂–∞" },
          { name: "–°“±–Ω–∞“õ" },
          { name: "“ö—ã—Ä“ì—ã–∑" },
          { name: "–ù–æ“ì–∞–π-“ö–∞–∑–∞“õ" },
          { name: "–ú–∞“£“ì—ã—Ç" },
          { name: "–ö”©–ª–µ–≥–µ–Ω" },
          { name: "–ö–µ–Ω–µ–≥–µ—Å" },
          { name: "“ö–∏—è—Ç" }
        ]
      }
    ]
  };

  // ========== –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –°–ï–ö–¶–ò–ô ==========
  const sections = document.querySelectorAll('.section');
  const icons = document.querySelectorAll('header .icon');
  
  icons.forEach(icon => {
    icon.addEventListener('click', function() {
      const sectionId = this.getAttribute('data-section');
      
      icons.forEach(i => i.classList.remove('active'));
      this.classList.add('active');
      
      sections.forEach(section => section.classList.remove('active'));
      document.getElementById(`${sectionId}-section`).classList.add('active');
      
      if (sectionId === 'people') {
        setTimeout(initTree, 100);
      }
      
      if (sectionId === 'stats') {
        updateStatistics();
      }
      
      if (sectionId === 'add') {
        updateParentSelect();
      }
    });
  });

  // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –î–ï–†–ï–í–ê ==========
function initTree() {
  const width = window.innerWidth;
  const height = window.innerHeight - 55;

  d3.select("#tree-container").html("");

  const svg = d3.select("#tree-container")
    .append("svg")
    .attr("width", width)
    .attr("height", height);

  const g = svg.append("g")
    .attr("transform", `translate(${width / 2 - 80}, ${height / 2})`);

  // ZOOM —Ñ—É–Ω–∫—Ü–∏—è
  const zoom = d3.zoom()
    .scaleExtent([0.1, 3])
    .on("zoom", (event) => {
      g.attr("transform", event.transform);
    });
  
  svg.call(zoom)
    .on("dblclick.zoom", null);

  // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –¥–µ—Ä–µ–≤–æ
  const treeLayout = d3.tree()
    .nodeSize([100, 250]);

  let root = d3.hierarchy(currentTreeData);

  // –°–í–û–†–ê–ß–ò–í–ê–ï–ú –í–°–ï –£–ó–õ–´ –ö–†–û–ú–ï –ê–õ–ê–®
  function collapseAllExceptRoot(d) {
    if (d.depth > 0 && d.children) {
      d._children = d.children;
      d._children.forEach(collapseAllExceptRoot);
      d.children = null;
    }
  }
  
  if (root.children) {
    root.children.forEach(collapseAllExceptRoot);
  }

  root.x0 = 0;
  root.y0 = 0;

  updateTree(root);

  function updateTree(source) {
    const duration = 400;
    treeLayout(root);

    const nodes = root.descendants();
    const links = root.links();

    const node = g.selectAll("g.node-group")
      .data(nodes, d => d.id || (d.id = ++i));

    /* ===== EXIT ===== */
    node.exit()
      .transition().duration(duration)
      .attr("transform", d => `translate(${source.y},${source.x})`)
      .style("opacity", 0)
      .remove();

    /* ===== ENTER ===== */
    const nodeEnter = node.enter()
      .append("g")
      .attr("class", "node-group")
      .attr("transform", `translate(${source.y0},${source.x0})`)
      .style("opacity", 0)
      .on("click", (e, d) => {
        e.stopPropagation();
        if (d.children) {
          d._children = d.children;
          d.children = null;
        } else {
          d.children = d._children;
          d._children = null;
        }
        updateTree(d);
      });

    // –ö–ê–†–¢–û–ß–ö–ê –£–ó–õ–ê
    nodeEnter.append("rect")
      .attr("class", d => `node-card ${d._children ? 'collapsed' : (d.children ? 'expanded' : '')}`)
      .attr("x", 0)
      .attr("y", -25)
      .attr("width", 160)
      .attr("height", 50)
      .attr("rx", 15)
      .attr("ry", 15);

    // –ö–†–£–ì–õ–ê–Ø –ú–ê–°–ö–ê –î–õ–Ø –§–û–¢–û
    nodeEnter.append("clipPath")
      .attr("id", d => `clip-${d.id}`)
      .append("circle")
      .attr("cx", 30)
      .attr("cy", 0)
      .attr("r", 20);

    // –§–û–¢–û
    nodeEnter.append("image")
      .attr("x", 10)
      .attr("y", -20)
      .attr("width", 40)
      .attr("height", 40)
      .attr("href", "images/yurt.png")
      .attr("clip-path", d => `url(#clip-${d.id})`)
      .attr("preserveAspectRatio", "xMidYMid slice");

    // –¢–ï–ö–°–¢
    nodeEnter.append("text")
      .attr("class", "node-text")
      .attr("x", 60)
      .attr("y", 0)
      .attr("dy", "0.35em")
      .text(d => d.data.name);

    /* ===== UPDATE ===== */
    const nodeUpdate = nodeEnter.merge(node);

    nodeUpdate.transition()
      .duration(duration)
      .attr("transform", d => `translate(${d.y},${d.x})`)
      .style("opacity", 1);

    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Å –∫–∞—Ä—Ç–æ—á–∫–∏
    nodeUpdate.select("rect")
      .attr("class", d => `node-card ${d._children ? 'collapsed' : (d.children ? 'expanded' : '')}`);

    // –ü–æ–¥–≥–æ–Ω—è–µ–º —à–∏—Ä–∏–Ω—É –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ–¥ —Ç–µ–∫—Å—Ç
    nodeUpdate.select("rect")
      .transition()
      .duration(duration)
      .attr("width", function() {
        const text = this.parentNode.querySelector("text");
        const textWidth = text ? text.getBBox().width : 0;
        return Math.max(160, textWidth + 70);
      });

    /* ===== LINKS ===== */
    const link = g.selectAll("path.link")
      .data(links, d => d.target.id);

    link.exit()
      .transition().duration(duration)
      .style("opacity", 0)
      .remove();

    link.enter()
      .append("path")
      .attr("class", "link")
      .merge(link)
      .transition()
      .duration(duration)
      .attr("d", d => {
        const sourceNode = d.source;
        const targetNode = d.target;
        const sourceRect = sourceNode.nodeRectWidth || 160;
        const targetRect = targetNode.nodeRectWidth || 160;
        
        const startX = sourceNode.y + sourceRect;
        const endX = targetNode.y;
        const startY = sourceNode.x;
        const endY = targetNode.x;
        
        // –ü–ª–∞–≤–Ω–∞—è –∫—Ä–∏–≤–∞—è –ë–µ–∑—å–µ
        const controlX1 = startX + (endX - startX) * 0.5;
        const controlX2 = startX + (endX - startX) * 0.5;
        
        return `
          M ${startX} ${startY}
          C ${controlX1} ${startY},
            ${controlX2} ${endY},
            ${endX} ${endY}
        `;
      })
      .style("opacity", 0.7);

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —à–∏—Ä–∏–Ω—É –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è —É–∑–ª–∞
    nodes.forEach(d => {
      d.x0 = d.x;
      d.y0 = d.y;
      const nodeElement = d3.select(d3.selectAll(".node-group").nodes()[nodes.indexOf(d)]);
      if (nodeElement.size() > 0) {
        const rect = nodeElement.select("rect").node();
        if (rect) {
          d.nodeRectWidth = rect.getBBox().width;
        }
      }
    });
  }

  // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –¥–µ—Ä–µ–≤–æ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
  setTimeout(() => {
    const initialTransform = d3.zoomIdentity
      .translate(width / 2 - 80, height / 2 - 100)
      .scale(1);
    svg.call(zoom.transform, initialTransform);
  }, 100);
}

  // ========== –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ü–û–ò–°–ö–ê ==========
  function searchInTree(query) {
    const results = [];
    const searchLower = query.toLowerCase();
    
    function traverse(node, path = []) {
      if (node.data && node.data.name.toLowerCase().includes(searchLower)) {
        results.push({
          name: node.data.name,
          path: [...path, node.data.name].join(' ‚Üí '),
          node: node
        });
      }
      
      if (node.children) {
        node.children.forEach(child => traverse(child, [...path, node.data.name]));
      }
      if (node._children) {
        node._children.forEach(child => traverse(child, [...path, node.data.name]));
      }
    }
    
    const root = d3.hierarchy(currentTreeData);
    traverse(root);
    return results;
  }

  // ========== –ü–û–ò–°–ö ==========
  const searchInput = document.querySelector('.search-box');
  const resultsList = document.getElementById('search-results-list');
  
  searchInput.addEventListener('input', function() {
    const query = this.value.trim();
    
    if (query.length < 2) {
      resultsList.innerHTML = '<p>–í–≤–µ–¥–∏—Ç–µ –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞</p>';
      return;
    }
    
    const results = searchInTree(query);
    
    if (results.length === 0) {
      resultsList.innerHTML = '<p>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
      return;
    }
    
    let html = '';
    results.forEach(result => {
      html += `
        <div class="result-item" data-name="${result.name}">
          <strong>${result.name}</strong>
          <div style="font-size: 12px; color: #666;">${result.path}</div>
        </div>
      `;
    });
    
    resultsList.innerHTML = html;
    
    document.querySelectorAll('.result-item').forEach(item => {
      item.addEventListener('click', function() {
        const name = this.getAttribute('data-name');
        alert(`–ü–µ—Ä–µ—Ö–æ–¥ –∫: ${name}\n(–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –ø–µ—Ä–µ—Ö–æ–¥–∞ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –ø–æ–∑–∂–µ)`);
      });
    });
  });

  // ========== –î–û–ë–ê–í–õ–ï–ù–ò–ï ==========
  function updateParentSelect() {
    const select = document.getElementById('parent-select');
    select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–¥–∏—Ç–µ–ª—è</option>';
    
    function addOptions(node, depth = 0) {
      const indent = '‚Äî '.repeat(depth);
      select.innerHTML += `<option value="${node.data.name}">${indent}${node.data.name}</option>`;
      
      if (node.children) {
        node.children.forEach(child => addOptions(child, depth + 1));
      }
    }
    
    const root = d3.hierarchy(currentTreeData);
    addOptions(root);
  }

  const addForm = document.querySelector('.add-form');
  addForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const name = document.getElementById('person-name').value;
    const parent = document.getElementById('parent-select').value;
    const info = document.getElementById('person-info').value;
    
    if (!name) {
      alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è');
      return;
    }
    
    if (!parent) {
      alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–¥–∏—Ç–µ–ª—è');
      return;
    }
    
    alert(`–î–æ–±–∞–≤–ª–µ–Ω: ${name}\n–†–æ–¥–∏—Ç–µ–ª—å: ${parent}\n–ò–Ω—Ñ–æ: ${info || '–Ω–µ—Ç'}`);
    this.reset();
  });

  // ========== –°–¢–ê–¢–ò–°–¢–ò–ö–ê ==========
  function updateStatistics() {
    function countNodes(node) {
      let total = 1;
      let leaves = 0;
      let maxDepth = 0;
      
      function traverse(n, depth = 0) {
        maxDepth = Math.max(maxDepth, depth);
        
        const hasChildren = (n.children && n.children.length > 0) || 
                          (n._children && n._children.length > 0);
        
        if (!hasChildren) {
          leaves++;
        }
        
        if (n.children) {
          n.children.forEach(child => {
            total++;
            traverse(child, depth + 1);
          });
        }
        if (n._children) {
          n._children.forEach(child => {
            total++;
            traverse(child, depth + 1);
          });
        }
      }
      
      traverse(node);
      
      return {
        total,
        leaves,
        maxDepth,
        branches: node.children ? node.children.length : 0
      };
    }
    
    const root = d3.hierarchy(currentTreeData);
    const stats = countNodes(root);
    
    document.getElementById('total-people').textContent = stats.total;
    document.getElementById('total-levels').textContent = stats.maxDepth + 1;
    document.getElementById('total-branches').textContent = stats.branches;
    document.getElementById('total-leaves').textContent = stats.leaves;
  }

  // ========== –ö–ù–û–ü–ö–ê + ==========
  document.querySelector('.floating-btn').addEventListener('click', function() {
    icons.forEach(i => i.classList.remove('active'));
    document.querySelector('[data-section="add"]').classList.add('active');
    
    sections.forEach(s => s.classList.remove('active'));
    document.getElementById('add-section').classList.add('active');
    
    updateParentSelect();
  });

  // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï ==========
  document.addEventListener('DOMContentLoaded', function() {
    initTree();
    updateStatistics();
    updateParentSelect();
    
    window.addEventListener('resize', function() {
      if (document.getElementById('people-section').classList.contains('active')) {
        setTimeout(initTree, 100);
      }
    });
  });
</script>
</body>
</html>
